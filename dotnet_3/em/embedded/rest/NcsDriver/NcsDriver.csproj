<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>netcoreapp3.1</TargetFramework>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="EvoMaster.Controller" Version="1.1.1-SNAPSHOT" />
        <PackageReference Include="EvoMaster.Instrumentation" Version="1.1.1-SNAPSHOT" />
    </ItemGroup>

    <ItemGroup>
        <ProjectReference Include="../../../../cs/rest/NCS/NCS.csproj" />
    </ItemGroup>

    <Target Name="appsettings" AfterTargets="AfterBuild">
        <Copy SourceFiles="../../../../cs/rest/NCS/appsettings.json" DestinationFolder="$(OutDir)" />
    </Target>

    <ItemGroup>
        <!-- You may only need to modify values for these two items based on the project names -->
        <Sut Include="NCS.dll" />
        <CurrentRuntimeConfig Include="$(OutputPath)NcsDriver.runtimeconfig.json" />

        <!-- Don't need to touch these two lines -->
        <TempDirectory Include="$(ProjectDir)bin-temp" />
        <InstrumentationRuntimeConfig Include="$(OutputPath)EvoMaster.Instrumentation.runtimeconfig.json" />
    </ItemGroup>

    <Target Name="Instrument" AfterTargets="Build">

        <!-- Remove temp folder in case it exists to make sure everything gets updated -->
        <RemoveDir Directories="@(TempDirectory)" />

        <!-- We create a separate directory to save the instrumented dll in, because we should keep both the SUT and its instrumented version:
         The original one is used to run the tests and the instrumented one is used during the search later -->
        <Exec Command="cp -a $(OutputPath). @(TempDirectory)" />

        <!-- create a runtimeconfig.json because it is needed for EvoMaster.Instrumentation.dll to be runnable -->
        <Copy SourceFiles="@(CurrentRuntimeConfig)" DestinationFiles="@(InstrumentationRuntimeConfig)" />

        <!-- Run the instrumentation and specify bin-temp as output directory -->
        <Exec Command="cd $(OutputPath);&#xD;&#xA;        dotnet EvoMaster.Instrumentation.dll @(TempDirectory)/@(Sut) @(TempDirectory)" />
    </Target>

    <!--This section enables running the instrumented SUT when calling the runSut api of the driver 
    The actual instrumentation is done before-->
    <ItemGroup>
        <TempContent Include="$(ProjectDir)bin-temp/." />
    </ItemGroup>
    <Target Name="TestInstrumentation" AfterTargets="Build">
        <!-- Fill the bin directory with contents from the temp folder -->
        <Delete Files="$(OutputPath)\*.*" />
        <Exec Command="cp -a @(TempContent) $(OutputPath)" />
        <!-- Rename the InstrumentedSut to the original name of the SUT  -->
        <Exec Command="cd $(OutputPath);mv InstrumentedSut.dll @(Sut)" />

    </Target>

</Project>
